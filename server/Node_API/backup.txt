import express from "express";
import mysql from "mysql";
import cors from "cors";
import axios from "axios";
import session from "express-session";
import cookieParser from "cookie-parser";
import { GoogleGenerativeAI } from "@google/generative-ai";
const Stripe = require('stripe');

const app = express();
app.use(express.json());
app.use(cookieParser());

// Configure session middleware
app.use(
  session({
    secret: "your-secret-key", // Add a secret key for session signing
    resave: false,
    saveUninitialized: true,
    cookie: {
      maxAge: 1000 * 60 * 60 * 24, // 1 day
      secure: false, // Set to true in production with HTTPS
      httpOnly: true, // Ensures the cookie is sent only over HTTP(S), not client JavaScript
    },
  })
);

// Define CORS configuration to allow requests from both Python script and frontend
app.use(
  cors({
    origin: ["http://localhost:5173"],
    methods: ["POST", "GET"],
    credentials: true, // Allow credentials (cookies, authorization headers, etc.)
  })
);

// Database connection
const db = mysql.createConnection({
  host: "localhost",
  user: "root",
  password: "",
  database: "houselens",
});

// Initialize Google Generative AI
const GOOGLE_GEN_AI_KEY = "AIzaSyDQBVzWS4OpIKHJ6f4IxENztwFCpoZU0YI";
const genAI = new GoogleGenerativeAI(GOOGLE_GEN_AI_KEY);

// GET Request to fetch data from Python API
app.get("/fetch-data-from-python", async (req, res) => {
  try {
    const response = await axios.get("http://localhost:5000/get-data");
    console.log("Data received from Python API:", response.data);
    res.json(response.data);
  } catch (error) {
    console.error("Error fetching data from Python API:", error);
    res.status(500).json({ error: "Internal Server Error" });
  }
});

// GET session route
app.get("/session", (req, res) => {
  if (req.session.username) {
    return res.json({ valid: true, username: req.session.user_id });
  } else {
    return res.json({ valid: false });
  }
});

// POST Request for user sign-in
app.post("/verifysignin", (req, res) => {
  const sql = "SELECT * FROM `user` WHERE user_username = ?";
  const subsql =
    "SELECT * FROM `user` WHERE user_username = ? AND user_password = ?";
  const values = [req.body.username, req.body.password];

  db.query(sql, [values[0]], (err, result) => {
    if (err) {
      return res.json(err);
    }
    if (result.length > 0) {
      db.query(subsql, values, (err, result2) => {
        if (err) {
          return res.json(err);
        }
        const user = result2[0];
        if (user.user_password === req.body.password) {
          req.session.user_id = user.user_id;
          req.session.username = user.user_username;
          return res.json({
            success: true,
            message: "Login successful",
            username: user.user_username,
          });
        } else {
          return res.json({ success: false, message: "Incorrect password" });
        }
      });
    } else {
      return res.json({ success: false, message: "User doesn't exist" });
    }
  });
});

// REGISTER
app.post("/register", async (req, res) => {
  const { fullname, email, username, password } = req.body;
  const freemium = "Free";

  try {
    // Prepare the SQL query
    const sql =
      "INSERT INTO `user` (`user_fullname`, `user_email`, `user_username`, `user_password`, `user_freemium`) VALUES (?, ?, ?, ?, ?)";
    const values = [username, password, fullname, email, freemium];

    // Execute the SQL query
    db.query(sql, values, (err, result) => {
      if (err) {
        return res.status(500).json({ error: err.message });
      }
      res.status(201).json({
        message: "User registered successfully",
        userId: result.insertId,
      });
    });
  } catch (err) {
    res.status(500).json({ error: "Error hashing password" });
  }
});

// POST Request to send and process data to Python API
app.post("/send-and-process-data", async (req, res) => {
  try {
    const { roomNum, area } = req.body;
    const dataObject = { roomNum, area, timestamp: new Date() };
    const response = await axios.post(
      "http://localhost:5000/process-data",
      dataObject
    );
    res.json(response.data);
  } catch (error) {
    console.error("Error fetching data from Python API:", error);
    res.status(500).json({ error: "Internal Server Error" });
  }
});

app.post("/houselist", (req, res) => {
  const { minPrice, maxPrice } = req.body;
  const q = "SELECT * FROM houselist WHERE House_Price BETWEEN ? AND ?";

  db.query(q, [minPrice, maxPrice], (err, data) => {
    if (err) {
      return res.json(err);
    }
    return res.json(data);
  });
});

// PREDICTION MODEL 
// ================================================================

app.post('/predict', async (req, res) => {
  try {
    // Extract data from the request body
    const { Location, Rooms, Bathrooms, 'Car Parks': CarParks, 'Property Type': PropertyType, Furnishing, 'Build Type': BuildType, Sqft } = req.body;

    // Prepare the data to send to the Flask endpoint
    const data = {
      Location,
      Rooms: Rooms.map(room => parseInt(room)),
      Bathrooms: Bathrooms.map(bathroom => parseInt(bathroom)),
      'Car Parks': CarParks.map(carPark => parseInt(carPark)),
      'Property Type': PropertyType,
      Furnishing,
      'Build Type': BuildType,
      Sqft: Sqft.map(sqft => parseInt(sqft))
    };

    // Send POST request to Flask endpoint
    const response = await axios.post('http://127.0.0.1:5000/predict', data);

    // Send the prediction result back to the client
    res.json(response.data);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).send('An error occurred while fetching the prediction.');
  }
});

// FORECASTING MODEL 
// ================================================================

app.post('/forecast', async (req, res) => {
  try {
    const { mortgageInterest, vacancyRate, cpi, medianSalesPrice } = req.body;

    const data = {
      "Mortgage Interest": parseFloat(mortgageInterest),
      "Vacancy Rate": parseFloat(vacancyRate),
      "CPI": parseFloat(cpi),
      "Median Sales Price": parseFloat(medianSalesPrice)
    };

    const response = await axios.post('http://127.0.0.1:5000/forecast', data);

    res.json(response.data);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).send('An error occurred while fetching the forecast.');
  }
});

// Test POST endpoint
app.post("/test", async (req, res) => {
  try {
    const response = { message: "fairuz babi" };
    res.json(response);
  } catch (error) {
    console.error("Error fetching data from Python API:", error);
    res.status(500).json({ error: "Internal Server Error" });
  }
});

// POST endpoint for Google Generative AI
app.post("/gemini", async (req, res) => {
  try {
    if (!genAI) {
      throw new Error("Generative AI module is not properly defined");
    }
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
    const message = req.body.message;
    const result = await model.generateContent(message);
    const generatedText = result.response.candidates[0].content.parts[0].text;
    res.json({ message: generatedText });
  } catch (error) {
    console.error("Error:", error.message);
    res.status(500).json({ error: error.message });
  }
});

// Logout endpoint
app.post("/logout", (req, res) => {
  req.session.destroy((err) => {
    if (err) {
      return res.status(500).json({ error: "Failed to logout" });
    }
    res.clearCookie("connect.sid"); // clear the session cookie
    return res.json({ success: true, message: "Logout successful" });
  });
});

const stripe = new Stripe('sk_test_51Pbya8RoC4Hvexv47rsi462KBkvMXwzNQyREjDLAGVXiwtHihRiEZiSFWqr6Tn9qYRojJvBT5gj1I27aWIaGtC9N00yBBQcKvi');
const endpointSecret = 'whsec_51d51f68d15ec9bae07f7550396b9121c39c8b05048ba11f85fb2f137bd310f7';
app.post('/webhook', (req, res) => {
  const sig = req.headers['stripe-signature'];
  let event;

  try {
    event = stripe.webhooks.constructEvent(req.body, sig, endpointSecret);
  } catch (err) {
    console.error('Webhook signature verification failed.', err);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  if (event.type === 'checkout.session.completed') {
    const session = event.data.object;
    const userID = session.client_reference_id;

    // Trigger payment success logic
    handlePaymentSuccess(userID);
  }

  res.status(200).json({ received: true });
});

const handlePaymentSuccess = (userID) => {
  const sql = "UPDATE `user` SET `user_freemium` = 'Premium' WHERE `user_id` = ?";
  db.query(sql, [userID], (err, result) => {
    if (err) {
      console.error("Database error:", err);
      return;
    }
    console.log("Payment recorded successfully, user upgraded to Premium");
  });
};

app.listen(8800, () => {
  console.log("Connected to backend on http://localhost:8800/");
});
